@using Microsoft.JSInterop
@inject IJSRuntime JSRuntime

<div class="card-container">
    <div class="card
                shadow-xl relative
                @CardClass"
         data-aos="fade-right" data-aos-offset="100"
         @ref="CardRef">

        <!-- Example figure (left image) -->
        <figure class="card-figure">
            <img class="@ImageClass" src="@Image" alt="@ImageAlt" />
        </figure>

        <!-- Card body content -->
        <div class="card-body">
            <h2 class="card-title">@Title</h2>
            <p>@Body</p>

            <!-- Example of tags -->
            <div class="card-tags">
                @foreach (var tag in Tags.Split(','))
                {
                    <span class="badge badge-outline">@tag</span>
                }
            </div>
        </div>

        @if (ShowDuration && !string.IsNullOrEmpty(StartDate))
        {
            <!-- The text behind the folded corner. 
                 This is visible once the corner rotates up. -->
            <div class="corner-text">
                <p class="text-sm font-medium">
                    @StartDate - @(string.IsNullOrEmpty(EndDate) ? "Present" : EndDate)
                </p>
                <p class="text-xs opacity-70">@CalculateDuration()</p>
            </div>

            <!-- The corner flap itself, same size as the clipped corner -->
            <div class="corner-fold"></div>
        }
    </div>
</div>

@code {
    [Parameter] public string Title { get; set; } = default!;
    [Parameter] public string Image { get; set; } = default!;
    [Parameter] public string ImageAlt { get; set; } = default!;
    [Parameter] public string ImageClass { get; set; } = default!;
    [Parameter] public string? CardClass { get; set; }
    [Parameter] public string Body { get; set; } = default!;
    [Parameter] public string Tags { get; set; } = default!;
    [Parameter] public string? StartDate { get; set; }
    [Parameter] public string? EndDate { get; set; }
    [Parameter] public bool ShowDuration { get; set; } = false;

    private ElementReference CardRef;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && ShowDuration && !string.IsNullOrEmpty(StartDate))
        {
            try
            {
                // Initialize Popmotion-based corner fold animation
                await JSRuntime.InvokeVoidAsync("initCornerFoldAnimation", CardRef);
            }
            catch (Exception ex)
            {
                // Gracefully handle if the animation library isn't loaded yet
                Console.WriteLine($"Corner fold animation failed: {ex.Message}");
            }
        }
    }

    private string CalculateDuration()
    {
        if (string.IsNullOrEmpty(StartDate)) return string.Empty;

        DateTime start = DateTime.Parse(StartDate);
        DateTime end = string.IsNullOrEmpty(EndDate) ? DateTime.Now : DateTime.Parse(EndDate);

        int years = end.Year - start.Year;
        int months = end.Month - start.Month;
        if (end.Day < start.Day) months--;

        if (months < 0)
        {
            years--;
            months += 12;
        }

        if (years > 0)
        {
            return years == 1
                ? $"{years} yr {months} mos"
                : $"{years} yrs {months} mos";
        }
        return $"{months} mos";
    }
}